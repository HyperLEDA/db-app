В этой документации описана последовательность действий для загрузки новой таблицы из Vizier.

## Установка окружения

Если не сделано, установить базовое окружение можно при помощи [этой инструкции](../dev/environment.ru.md).

## Скачивание и загрузка таблицы из Vizier

1. Загрузить набор скриптов для leda:
    ```bash
    git clone https://github.com/HyperLEDA/uploader.git
    cd uploader
    ```

2. Запустить загрузку:
    ```bash
    uv run cli.py upload vizier <catalog_name> <table_name>
    ```

    `catalog_name` и `table_name` - имена каталога и таблицы из Vizier, которые хочется загрузить. Например, для каталога [Siena Galaxy Atlas](https://vizier.cds.unistra.fr/viz-bin/VizieR-3?-source=J/ApJS/269/3/sga2020&-out.max=50&-out.form=HTML%20Table&-out.add=_r&-out.add=_RAJ,_DEJ&-sort=_r&-oc.form=sexa) команда будет выглядеть вот так:

    ```bash
    uv run cli.py upload vizier J/ApJS/269/3 J/ApJS/269/3/sga2020
    ```

    Скрипт задаст несколько вопросов, большинство из которых можно будет оставить пустыми - они заполнятся по умолчанию тем, что написано в квадратных скобках. В частности, внутреннее имя таблицы и ADS bibcode будут заполнены автоматически на основе данных из Vizier. Заполнить рекомендуется только описание - по нему в будущем можно будет искать таблицы.

3. Ждать, пока загрузка кончится. Она состоит из двух шагов: скачивание таблицы из Vizier и загрузка этой таблицы в HyperLeda. Если на моменте загрузки в HyperLeda загрузка оборвётся по какой-либо причине, файл из Vizier будет закеширован и скачивать его заново не придётся - можно просто перезапустить команду.

    По итогам этого шага таблица будет загружена на уровень 0 БД.

## Разметка таблицы

1. При необходимости можно изменить метаданные таблицы. Для этого есть метод `PATCH /admin/api/v1/table`. Один из принимаемых параметров - `table_name` - имя таблицы, указанное при загрузке. Метод позволяет сделать несколько действий:
    1. Поменять или проставить UCD у столбца таблицы.
        ```json
        {
            "table_name": "my_table_name",
            "actions": [
                {
                    "type": "change_ucd",
                    "column": "column_name",
                    "ucd": "pos.eq.ra"
                }
            ]
        }
        ```

        Для справки список UCD и их значений можно найти в [спецификации IVOA](https://cdsweb.u-strasbg.fr/UCD/).

    2. Поменять или проставить единицы измерения у столбца таблицы. 
        ```json
        {
            "table_name": "my_table_name",
            "actions": [
                {
                    "type": "change_unit",
                    "column": "column_name",
                    "unit": "km/s"
                }
            ]
        }
        ```

        Единицы измерения могут быть произвольной сложности. Для их парсинга используется [astropy](https://docs.astropy.org/en/stable/units/format.html#converting-from-strings), так что список допустимых форм совпадает с тем, что принимает парсер этого модуля, но он очень широкий - в большинстве случаев об этом можно не думать.

6. Правильно разметить таблицу можно при помощи [инструкции](./marking.md).
